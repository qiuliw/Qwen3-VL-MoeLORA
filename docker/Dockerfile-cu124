ARG CUDA_VERSION=12.4.0
ARG FROM_IMAGE=nvidia/cuda:${CUDA_VERSION}-devel-ubuntu22.04

FROM ${FROM_IMAGE} as base

ARG DEBIAN_FRONTEND=noninteractive

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    git-lfs \
    python3 \
    python3-pip \
    python3-dev \
    wget \
    libsndfile1 \
    ffmpeg \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 安装 CMake
RUN wget -q https://github.com/Kitware/CMake/releases/download/v3.26.1/cmake-3.26.1-Linux-x86_64.sh \
    -O /tmp/cmake-install.sh \
    && chmod u+x /tmp/cmake-install.sh \
    && mkdir /opt/cmake-3.26.1 \
    && /tmp/cmake-install.sh --skip-license --prefix=/opt/cmake-3.26.1 \
    && rm /tmp/cmake-install.sh \
    && ln -s /opt/cmake-3.26.1/bin/* /usr/local/bin

RUN ln -s /usr/bin/python3 /usr/bin/python && \
    git lfs install

# 设置工作目录
WORKDIR /app

# 升级 pip
RUN pip3 install --upgrade pip setuptools wheel

# 安装 PyTorch (CUDA 12.4)
RUN pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124

# 安装 transformers (最新版本支持 Qwen3-VL)
RUN pip3 install git+https://github.com/huggingface/transformers

# 复制依赖文件
COPY requirements.txt /app/
COPY multi_agent/requirements.txt /app/multi_agent/

# 安装项目依赖
RUN pip3 install -r requirements.txt && \
    pip3 install -r multi_agent/requirements.txt

# 安装 bitsandbytes (需要编译)
RUN pip3 install bitsandbytes --no-build-isolation

# 复制项目文件
COPY . /app/

# 创建必要的目录
RUN mkdir -p /app/output \
    /app/qwen3-vl-4b-instruct \
    /app/coco_2014_caption \
    /app/rag_data \
    /app/multi_agent/knowledge_base \
    /app/multi_agent/output/reports

# 设置环境变量
ENV PYTHONPATH=/app
ENV CUDA_VISIBLE_DEVICES=0

# 默认命令
CMD ["/bin/bash"]

